<?php

/**
 * @file
 * Defines a field type for referencing other entites.
 */

/**
 * Implements hook_entity_info_alter().
 *
 * TO DO: Patch core entities to have each provide its own values
 */
function reference_entity_info_alter(&$entity_info) {
  $entity_info['node']['entity keys']['label'] = 'title';
  $entity_info['node']['entity keys']['status'] = 'status';
}

/**
 * Implements hook_field_info().
 */
function reference_field_info() {
  return array(
    'reference' => array(
      'label' => t('Reference'),
      'description' => t('Defines a field type for referencing other entites.'),
      'instance_settings' => array('entity_type' => '', 'bundle' => '', 'status' => ''),
      'default_widget' => 'reference_autocomplete',
      'default_formatter' => 'simple_link',
    ),
  );
}

/**
 * Implements hook_field_settings_form().
 */
function reference_field_settings_form($field, $instance, $has_data) {
  $settings = $field['settings'];
  $form = array();
  $form['entity_type'] = array(
    '#type' => 'select',
    '#title' => t('Select entity type to reference'),
    '#options' => _reference_entity_options(),
    '#default_value' => isset($settings['entity_type']) ? $settings['entity_type'] : 'node',
  );
  return $form;
}

/**
 * Implements hook_field_instance_settings_form().
 */
function reference_field_instance_settings_form($field, $instance) {
  $settings = $instance['settings'];
  $form['status'] = array(
    '#type' => 'checkbox',
    '#title' => t('Limit to published content'),
    '#default_value' => $settings['status'],
  );
  $form['bundles'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Limit to bundles'),
    '#options' => _reference_entity_bundle_options($field['settings']['entity_type']),
    '#multiple' => TRUE,
    '#description' => t('Leave unchecked to allow all entity type bundles to be referenced.'),
    '#default_value' => isset($settings['bundles']) ? $settings['bundles'] : array(),
  );
  return $form;
}

/**
 * Implements hook_field_is_empty().
 */
function reference_field_is_empty($item, $field) {
  if(empty($item['target_type']) && empty($item['target_id'])) {
    return true;
  }
  return false;
}

/**
 * Implements hook_field_widget_info().
 */
function reference_field_widget_info() {
  return array(
    'reference_autocomplete' => array(
      'label' => t('Autocomplete'),
      'field types' => array('reference'),
    ),
  );
}

/**
 * Implements hook_field_widget_form().
 */
function reference_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta, $element) {
  $element['target_type'] = array(
    '#type' => 'select',
    '#description' => 'Entity type',
    '#options' => array($field['settings']['entity_type'] => entity_get_info($field['settings']['entity_type'])['label']),
    '#default_value' => isset($items[$delta]['target_type']) ? $items[$delta]['target_type'] : '',
  );
  $element['target_id'] = array(
    '#type' => 'textfield',
    '#description' => 'Entity id',
    '#default_value' => isset($items[$delta]['target_id']) ? $items[$delta]['target_id'] : '',
  );
  return $element;
}

/**
 * Implements hook_field_formatter_info().
 */
function reference_field_formatter_info() {
  return array(
    'simple_link' => array(
      'label' => t('Simple link'),
      'field types' => array('reference'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function reference_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();
  switch ($display['type']) {
    case 'simple_link':
      foreach ($items as $delta => $target) {
          $target_type_info = entity_get_info($target['target_type']);
          $target_label_property = $target_type_info['entity keys']['label'];
          $target_entity = entity_load($target['target_type'], $target['target_id']);
          $element[] = array(
            '#markup' => l(t($target_entity->$target_label_property), $target_entity->path['source']),
          );
      }
    break;
  }
  return $element;
}

/**
 * Helper function to get the entity types
 */
function _reference_entity_options() {
  $options = array();
  $entity_types = entity_get_info();
  foreach ($entity_types as $key => $type) {
    $options[$key] = $type['label'];
  }
  return $options;
}

/**
 * Helper function to get the bundle info for an entity type and turn it into an array for select options
 */
function _reference_entity_bundle_options($entity_type) {
  $options = array();
  $bundles = field_info_bundles($entity_type);
  foreach ($bundles as $key => $info) {
    $options[$key] = $info['label'];
  }
  return $options;
}